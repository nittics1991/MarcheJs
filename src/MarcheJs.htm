<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="Cache-Control" content="no-cache">
<title>MarcheJs Job Time Machine</title>
<style>

/**
*   user-setting
*/

:root {
    --color-background:#c0c0c0;
    
    --color-main:#BF4444;
    --color-main-reverse:#cccccc;
    --color-sub:#0E2630;
    --color-sub-reverse:#ffffff;
    
    --color-info:#0F80F8;
    --color-error:#F90ECF;
    --color-shadow:#333333bb;
    
    --color-title:var(--color-main);
    --background-color-title:#2C97C6;
    
    --border-style:solid;
    --border-width:thin;
    
    --width-contents:320px;
    --min-height-contents:320px;
    --font-size:16px;
}


/**
*   foundation-reset
*/

* {box-sizing:border-box;}

body {margin:0;}

h1,h2,h3,h4,h5,h6 {margin:0;}

h1 {font-size:2.0rem;}
h2 {font-size:1.8rem;}
h3 {font-size:1.6rem;}
h4 {font-size:1.4rem;}
h5 {font-size:1.2rem;}
h6 {font-size:1.0rem;}

ul, ol {
    list-style:none;
    margin:0;
    padding:0;
}

button, input, select, textarea {
    font-family:inherit;
    font-size:inherit;
}

table {border-collapse:collapse;}


/**
*   mainmast
*/

html {
    font-size:var(--font-size);
}

body {
    color:var(--color-main);
    background-color:var(--color-background);
}

#main {
    display:flex;
    flex-wrap:wrap;
}

article {
    width:var(--width-contents);
    min-height:var(--min-height-contents);
    padding:2px;
}

nav ul, nav ol {
    display:flex;
}



/**
*   object-common
*/

h2 {
    white-space:nowrap;
}

button, input, select, textarea {
    color:var(--color-main);
    background-color:var(--color-main-reverse);
}

:invalid {
    border-color:var(--color-error);
}

.table-main {
    border-color:var(--color-sub);
    border-style:var(--border-style);
    border-width:var(--border-width);
    background-color:var(--color-main-reverse);
    table-layout:fixed;
    overflow:hidden;
    width:100%;
}

.table-main tr,
    .table-main th,
    .table-main td {
    border-color:var(--color-sub);
    border-style:var(--border-style);
    border-width:var(--border-width);
    overflow:hidden;
}

.table-position {
    border:0;
    table-layout:fixed;
    overflow:hidden;
    width:100%;
}

.modal {
    left:0;
    top:0;
    height:100%;
    width:100%;
    overflow:auto;
    z-index:1;
    background-color:var(--color-shadow);
}

.modal > * {
    position:fixed;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
}


/**
*   utility
*/

.display-none {
    display:none;
}

.position-fixed {
    position:fixed;
}

.background-color-info {
    background-color:var(--color-info);
}

.background-color-error {
    background-color:var(--color-error);
}


/**
*   object
*/

html {
  scroll-padding-top:4rem;
}

/*header*/
header {
    position:sticky;
    top:0;
}

h1 {
    text-align:center;
    color:var(--color-title);
    background-color:var(--background-color-title);
    padding-top:0.1rem;
    padding-bottom:0.1rem;
    max-height:2.2rem;
}


/*header nav*/
header > nav {
    background-color:var(--color-main);
}

header li {
    margin-left:2px;
    margin-top:2px;
    margin-right:0.5rem;
}

header a:link, a:visited {
    color:var(--color-main-reverse);
    text-decoration:none;
}

header nav button {
    border:none;
    outline:none;
    background:transparent;
    font-size:inherit;
    color:var(--color-main-reverse);
    cursor: pointer;
}


/*job_input_view*/
#job_input_view li:first-child{
    width:100%;
}

#job_input_view li:last-child{
    flex-shrink:0;
}

input[name="job_name"] {
    width:inherit;
}

button[name="job_name_button"] {
    width:4rem;
}


/*timecard_view*/
#timecard_table td:nth-child(3) {
    text-align:center;
}

#timecard_table td:last-child {
    text-align:right;
}

#timecard_table th:nth-child(3)
    ,#timecard_table th:last-child {
    width:5rem;
}



/*total_data_view*/
#total_data_table td:last-child {
    text-align:right;
}

#total_data_table th:last-child {
    width:5rem;
}



/*auto_date_table*/
#auto_date_table th:nth-child(3)
    ,#auto_date_table th:last-child {
    width:5rem;
}

#auto_date_table td:nth-child(3) {
    text-align:center;
}

#auto_date_table td:last-child {
    text-align:center;
}

input[name="config_expiration"] {
    width:3rem;
}


/*help_view*/

#help_view ol {
    counter-reset:count 0;
    padding:1em;
}

#help_view ol li:before {
  content:counter(count) ". ";
  counter-increment:count 1;
}

#help_view li {
    font-size:max(0.8rem, 10px);
    padding-bottom:1em;
}

#help_view aside li {
    font-size:max(0.6rem, 10px);
}

#help_view aside ol li:before {
  content:"補足" counter(count) ". ";
  counter-increment:count 1;
}

#help_view aside ol {
    counter-reset:count 0;
}


/*csv_view*/
#csv_view > div {
    color:var(--color-sub);
    background-color:var(--color-sub-reverse);
    width:50%;
}

#csv_view > div > div {
    position:static;
    text-align:center;
    width:100%;
}

#csv_view textarea {
    box-sizing:border-box;
    width:100%;
    max-width:100%;
}

#csv_view textarea
    ,#csv_view button {
    color:inherit;
    background-color:inherit;
}


/*message_view*/
#message_view > div {
    padding-top:1rem;
    padding-bottom:1rem;
    padding-left:4rem;
    padding-right:4rem;
    color:#000000;
}


/*media query*/
@media screen and (max-width:768px) {
    .table-main td {
        height:4rem;
    }
}


</style>

</head>
<body>

<div id="container">

<header>
    <h1 title="Version:1.0.0">MarcheJs Job Time Machine</h1>
    
    <nav>
        <ul>
            <li><a href="#container" title="トップページへ移動">TOP</a></li>
            <li><a href="#job_input_view" title="JOB入力へ移動">JOB入力</a></li>
            <li><a href="#timecard_view" title="タイムカードへ移動">タイムカード</a></li>
            <li><a href="#total_data_view" title="集計へ移動">集計</a></li>
            <li><a href="#config_view" title="設定へ移動">設定</a></li>
            <li><button name="csv_button" title="CVSデータ表示">データ入出力</button></li>
            <li><a href="#help_view" title="使い方へ移動">使い方</a></li>
        </ul>
    </nav>
</header>

<section id="main">
    <article id="job_input_view">
        <h2>JOB入力</h2>
        
        <nav>
            <ul>
                <li><input type="text" name="job_name" pattern="^[^\x00-\x1f\x7f]+$"></li>
                <li><button name="job_name_button">登録</button></li>
            </ul>
        </nav>
        
        <table id="job_input_table" class="table-main">
            <thead>
                <tr>
                    <th>JOB名</th>
                </tr>
            </thead>
            <tbody title="ダブルクリックで記録">
            </tbody>
        </table>
    </article>
    
    <article id="timecard_view">
        <h2>タイムカード</h2>
        
        <nav>
            <ul>
                <li><input type="date" name="job_date"></li>
            </ul>
        </nav>
        
        
        <table id="timecard_table" class="table-main">
            <thead>
                <tr>
                    <th class="display-none">ID</th>
                    <th>JOB名</th>
                    <th>開始時刻</th>
                    <th>作業(h)</th>
                </tr>
            </thead>
            <tbody title="ダブルクリックで削除">
            </tbody>
        </table>
    </article>
    
    <article id="total_data_view">
        <h2>集計</h2>
        
        <nav>
            <ul>
                <li><input type="date" name="job_date"></li>
            </ul>
        </nav>
        
        <table id="total_data_table" class="table-main">
            <thead>
                <tr>
                    <th>JOB名</th>
                    <th>作業(h)</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </article>
    
    <article id="config_view">
        <h2>設定</h2>
        
        <table id="config_input_table" class="table-position">
            <tbody>
                <tr>
                    <td>データ保持日数</td>
                    <td>
                        <input type="number" name="config_expiration" min="0" max="400" title="登録日数以前のデータを自動削除する。0は既定値">
                        <button name="config_expiration_button">登録</button>
                    </td>
                </tr>
                
                <tr>
                    <td>自動JOB名</td>
                    <td><input type="text" name="auto_date_job" title="指定時間にスタートするJOB名" pattern="^[^\x00-\x1f\x7f]+$"></td>
                </tr>
                
                <tr>
                    <td>自動開始</td>
                    <td><input type="time" name="auto_date_start" title="指定時間にJOBをスタートする"></td>
                </tr>
                
                <tr>
                    <td>自動再開</td>
                    <td><input type="time" name="auto_date_end" title="指定時間に前JOBを再スタートする。未指定の場合は何もしない"></td>
                </tr>
                
                <tr>
                    <td></td>
                    <td><button name="auto_date_button">登録</button></td>
                </tr>
            </tbody>
        </table>
        
        <h3>自動JOB</h3>
        
        <table id="auto_date_table" class="table-main">
            <thead>
                <tr>
                    <th class="display-none">ID</th>
                    <th>JOB名</th>
                    <th>開始</th>
                    <th>再開</th>
                </tr>
            </thead>
            <tbody title="ダブルクリックで削除">
            </tbody>
        </table>
        
    </article>
    
    <article id="help_view">
        <h2>はじめに</h2>
        
        <ol>
            <li>工数管理を補助する機能を提供する</li>
            <li>ある仕事・作業(以下JOB)の開始時に、入力/選択したJOBのJOB名と開始時間を登録する</li>
            <li>登録されたJOBは、日単位でタイムカードを一覧表示する</li>
            <li>また、JOB単位に作業時間の集計を一覧表示する</li>
            <li>この作業は、別のJOBを開始する毎に行う事で、工数を把握する</li>
            <li>登録データは、ブラウザのローカルストレージに保存する</li>
            <li>CSV形式で全登録データを表示する事が出来る</li>
        </ol>
        
        <h2>使い方</h2>
        
        <h3>基本操作</h3>
        
        <ol>
            <li>JOB入力ボックスにJOB名を入力し、JOBを登録する</li>
            <li>タイムカード一覧にJOB名と開始時刻・作業時間が表示される</li>
            <li>同時に集計一覧にJOB毎の作業時間を表示する</li>
            <li>JOB入力一覧にJOBが既に登録されている場合、JOB名をダブルクリックすると、JOB入力ボックスと同様の動作を行う</li>
            <li>この作業は、別のJOBを開始する毎に行う</li>
            <li>タイムカード一覧にてJOB名をダブルクリックすると、登録データを削除する</li>
            <li>業務終了時、集計一覧に表示された作業時間が、一日の業務記録となる</li>
        </ol>
        
        <aside>
            <ol>
                <li>業務の終了を表すJOB名を用意すると、業務終了時に登録する事で一日の作業時間も把握できる</li>
            </ol>
        </aside>
        
        <h3>データ管理</h3>
        
        <ol>
            <li>データは、ブラウザのローカルストレージに保存する</li>
            <li>データは一定期間後、あるいは設定のデータ保持日数を経過すると削除する</li>
            <li>タイムカードあるいは集計のカレンダーを変更する事で、過去のデータを表示する事が出来る</li>
            <li>データ入出力をクリックすると、全データをCSV形式で表示する事が出来る</li>
            <li>データ入出力のエクスポートボタンで全データをダウンロード出来る</li>
            <li>データ入出力へダウンロードしたファイルをドロップすると全データを上書きインポート出来る</li>
        </ol>
        
        <h3>自動JOB</h3>
        
        <ol>
            <li>休憩時間等、毎日定時刻に発生するJOBを、自動的にタイムカードへ登録する事が出来る</li>
            <li>設定にて、自動JOB名と自動開始時刻を登録する</li>
            <li>指定時間を経過すると、画面表示/更新時にJOBを追加する</li>
            <li>指定時間が最新登録データ時間よりも過去の場合、JOBは追加しない</li>
            <li>自動再開時刻も登録すると、自動的に直前のJOBを追加する</li>
            <li>自動開始時刻と自動再開時刻の間に手動でJOBを登録すると、自動再開時刻にJOBは追加しない</li>
            <li>処理する順序は自動開始時刻順で、開始時刻・再開時刻を処理後、次の自動JOBを処理する</li>
            <li>自動JOB一覧にてJOB名をダブルクリックすると、自動JOBデータを削除する</li>
        </ol>
        
        <aside>
            <ol>
            </ol>
        </aside>
        
    </article>
    
</section>

<section id="csv_view" class="modal display-none">
    <div>
        <div>
            <textarea name="csv_data"></textarea>
        </div>
        <div>
            <button name="export_button">エクスポート</button>
            <button name="csv_close_button">閉じる</button>
        </div>
    </div>
</section>

<section id="message_view" class="modal display-none">
    <div>
    </div>
</section>



</div>

<script>

////////////////////////////////////

const _MESSGAGE_DELAY_INFO = 2;     //メッセージウィンドウ通知 表示時間
const _MESSGAGE_DELAY_ERROR = 3;    //メッセージウィンドウエラー 表示時間

////////////////////////////////////

/**
*   EventDispatcher
*/
class EventDispatcher {
    /**
    *   @var array
    */
    _listeners = []; 
    
    /**
    *   addEventListener
    *
    *   @param string name
    *   @param callable callback
    *   @return this
    */
    addEventListener(name, callback) {
        if(!this._listeners[name]) {
            this._listeners[name] = [];
        }
        
        this._listeners[name].push(callback);
        return this;
    }
    
    /**
    *   removeEventListener
    *
    *   @param string name
    *   @param callable callback
    *   @return this
    */
    removeEventListener(name, callback) {
        if(!this.listeners[name]) {
            return this;
        }
        
        let that = this;
        this._listeners[name].forEach((current, index) => {
            if (current == callback) {
                that.listeners[name].splice(index, 1);
            }
        });
        return this;
    }
    
    /**
    *   dispatchEvent
    *
    *   @param string name
    *   @param mixed event
    *   @return mixed[] 実行結果
    */
    dispatchEvent(name, event) {
        if(this._listeners[name] == undefined
        || this._listeners[name].length == 0
        ) {
            return [];
        }
        
        event.type = name;
        
        return this._listeners[name].map((callback) => {
            return callback(event);
        });
    }
}

///////////////////////////////

/**
*   UnixDate
*
*/
class UnixDate
{
    /**
    *   now
    *
    *   @return int unixtime
    */
    static now() {
        return (new Date()).getTime();
    }
    
    /**
    *   today
    *
    *   @return int unixtime
    */
    static today() {
        const now = new Date();
        
        return new Date(
            now.getFullYear(),
            now.getMonth(),
            now.getDate(),
            0,
            0,
            0
        ).getTime();
    }
    
    /**
    *   byStrDate
    *
    *   @param string date_string yyyy-mm-dd
    *   @return int unixtime
    */
    static byStrDate(date_string) {
        return new Date(date_string + ' 00:00:00.000').getTime();
    }
    
    /**
    *   modifyDate
    *
    *   @param int unixtime
    *   @param int date_number
    *   @return unixtime
    */
    static modifyDate(unixtime, date_number) {
        return unixtime + (date_number * 60 * 60 * 24 * 1000);
    }
    
    /**
    *   unixtime => Date
    *
    *   @param str_unixtime
    *   @return Date
    */
    static toDate(str_unixtime) {
        return new Date(str_unixtime);
    }
    
    /**
    *   setTimeString
    *
    *   @param int unixtime
    *   @param int time_string
    *   @return unixtime
    */
    static setTimeString(unixtime, time_string) {
        const dt = UnixDate.toDate(unixtime);
        
        return new Date(
            dt.getFullYear() + '-' +
            (dt.getMonth() + 1) + '-' +
            dt.getDate() + ' ' +
            time_string
        ).getTime();
    }
    
    /**
    *   isToday
    *
    *   @param int unixtime
    *   @return bool
    */
    static isToday(unixtime) {
        const min_unixtime = UnixDate.today();
        const max_unixtime = UnixDate.modifyDate(
            min_unixtime,
            1
        );
        
        return unixtime >= min_unixtime
            && unixtime < max_unixtime;
    }
}

/**
*   DateFormatter
*
*/
class DateFormatter
{
    /**
    *   日付文字列取得
    *
    *   @param str_unixtime
    *   @return string
    */
    static toDate(str_unixtime) {
        let dt;
        
        try {
            dt = new Date(parseInt(str_unixtime));
        } catch (e) {
            return '';
        }
        return (new Date(
            str_unixtime - dt.getTimezoneOffset() * 60 * 1000)
        ).toISOString()
        .substr(0,10);
    }
    
    /**
    *   時刻文字列取得
    *
    *   @param str_unixtime
    *   @return string
    */
    static toTime(str_unixtime) {
        let dt;
        
        try {
            dt = new Date(parseInt(str_unixtime));
        } catch (e) {
            return '';
        }
        return (new Date(
            str_unixtime - dt.getTimezoneOffset() * 60 * 1000)
        ).toISOString()
        .substr(11,5);
    }
}


//////////////////////////////////

/**
*   MarcheDataCollection
*
*/
class MarcheDataCollection
{
    /**
    *   _storage_data
    *
    *   @var object
    */
    _storage_data;
    
    /**
    *   constructor
    *
    *   @param object
    */
    constructor(storage_data) {
        this._storage_data = storage_data;
    }
    
    /**
    *   set
    *
    *   @param string id
    *   @param string jobname
    *   @return this
    */
    set(id, jobname) {
        this._storage_data[id] = jobname;
        return this;
    }
    
    /**
    *   get
    *
    *   @param string id
    *   @return ?string
    */
    get(id) {
        return this._storage_data[id] || null;
    }
    
    /**
    *   remove
    *
    *   @param string id
    *   @return this
    */
    remove(id) {
        delete this._storage_data[id];
        return this;
    }
    
    /**
    *   has
    *
    *   @param string id
    *   @return bool
    */
    has(id) {
        return this.get(id) != null;
    }
    
    /**
    *   all
    *
    *   @return object
    */
    all() {
        return this._storage_data;
    }
    
    /**
    *   first
    *
    *   @return ?object
    */
    first() {
        const storage_data = this._storage_data;
        
        return storage_data[
            Object.keys(storage_data).sort()[0]
        ] || null;
    }
    
    /**
    *   last
    *
    *   @return ?object
    */
    last() {
        let storage_data = this._storage_data;
        
        return storage_data[
            Object.keys(storage_data).reverse()[0]
        ] || null;
    }
    
    /**
    *   firstId
    *
    *   @return ?int
    */
    firstId() {
        let storage_data = this._storage_data;
        
        return parseInt(Object.keys(storage_data).sort()[0])
            || null;
    }
    
    /**
    *   lastId
    *
    *   @return ?int
    */
    lastId() {
        const storage_data = this._storage_data;
        
        return parseInt(Object.keys(storage_data).sort().slice(-1)[0])
            || null;
    }
    
    /**
    *   findByJobName
    *
    *   @param string jobname
    *   @return array
    */
    findByJobName(jobname) {
        const storage_data = this._storage_data;
        
        return Object.values(storage_data).filter((inner_jobname) => {
            return inner_jobname === jobname;
        });
    }
    
    /**
    *   groupByJobName
    *
    *   @return array
    */
    groupByJobName() {
        const storage_data = this._storage_data;
        
        let uniques = [];
        
        Object.values(storage_data).forEach((jobname) => {
            if (uniques.indexOf(jobname) === -1) {
                uniques.push(jobname);
            }
        });
        
        return uniques;
    }
    
    /**
    *   findByDateString
    *
    *   @param string date_string yyyy-mm-dd
    *   @return array [[id,name,start_time,diff_time],...]
    */
    findByDateString(date_string) {
        const storage_data = this._storage_data;
        
        const min_unixtime = UnixDate.byStrDate(date_string);
        const max_unixtime = UnixDate.modifyDate(min_unixtime, 1);
        
        let dataset = [];
        let prev_data = 0;
        
        Object.keys(storage_data).sort().forEach((jobtime) => {
            if (parseInt(jobtime) >= min_unixtime
                && parseInt(jobtime) < max_unixtime
            ) {
                const diff_time = (
                    (parseInt(jobtime) - prev_data) / 1000 / 60 / 60
                ).toFixed(2);
                
                dataset.push({
                    id:jobtime,
                    name:storage_data[jobtime],
                    start_time:DateFormatter.toTime(jobtime),
                });
                
                if (prev_data) {
                    dataset[dataset.length - 2]['diff_time'] = diff_time;
                }
                
                prev_data = parseInt(jobtime);
            }
        });
        
        return dataset;
    }
    
    /**
    *   groupByDateString
    *
    *   @param string date_string yyyy-mm-dd
    *   @return array [[name,diff_time],...]
    */
    groupByDateString(date_string) {
        const storage_data = this._storage_data;
        
        const min_unixtime = UnixDate.byStrDate(date_string);
        const max_unixtime = UnixDate.modifyDate(min_unixtime, 1);
        
        let prev_pos = -1;
        let prev_data = 0;
        let total_key = [];
        let total_data = [];
        
        Object.keys(storage_data).sort().forEach((jobtime) => {
            if (parseInt(jobtime) >= min_unixtime
                && parseInt(jobtime) < max_unixtime
            ) {
                const diff_time =
                    parseInt(jobtime) - prev_data;
                let pos;
                
                if ((pos = total_key.indexOf(storage_data[jobtime])) === -1) {
                    pos = total_key.push(storage_data[jobtime]) - 1;
                    total_data[pos] = 0;
                }
                
                total_data[prev_pos] += prev_pos > -1? diff_time:0;
                
                prev_pos = pos;
                prev_data = parseInt(jobtime);
            }
        });
        
        return total_key.map((jobname, i) => {
            const diff_time = total_data[i]?
                (total_data[i] / 1000 / 60 / 60).toFixed(2):0;
            
            return{
                name:jobname,
                diff_time:diff_time * 1,
            };
        });
    }
    
    /**
    *   groupByJobNameOrderDesc
    *
    *   @return array
    */
    groupByJobNameOrderDesc() {
        const storage_data = this._storage_data;
        
        let uniques = [];
        
        Object.values(storage_data).reverse().forEach((jobname) => {
            if (uniques.indexOf(jobname) === -1) {
                uniques.push(jobname);
            }
        });
        
        return uniques;
    }
}


/**
*   MarcheConfig
*
*/
class MarcheConfig
{
    /**
    *   _storage_data
    *
    *   @var object
    */
    _storage_data;
    
    /**
    *   constructor
    *
    *   @param object
    */
    constructor(storage_data) {
        this._storage_data = storage_data;
    }
    
    /**
    *   set
    *
    *   @param string id
    *   @param string dataset
    *   @return this
    */
    set(id, dataset) {
        this._storage_data[id] = dataset;
        return this;
    }
    
    /**
    *   get
    *
    *   @param string id
    *   @return ?string
    */
    get(id) {
        return this._storage_data[id] || null;
    }
    
    /**
    *   remove
    *
    *   @param string id
    *   @return this
    */
    remove(id) {
        delete this._storage_data[id];
        return this;
    }    
    /**
    *   autoDates
    *
    *   @return array [id,auto_date_job,auto_date_start,auto_date_end]
    */
    autoDates() {
        return this._storage_data['auto_date'] || {};
    }
}


//////////////////////////////////////////

/**
*   MarcheRepository
*
*/
class MarcheRepository
{
    /**
    *   _DATA_NAMESPACE
    *
    *   @var string
    */
    _DATA_NAMESPACE = 'MarcheJs';
    
    /**
    *   _STORAGE_DATA
    *
    *   @var string
    */
    _STORAGE_DATA = '_storage_data';
    
    /**
    *   _CONFIG_NAMESPACE
    *
    *   @var string
    */
    _CONFIG_NAMESPACE = 'MarcheJs_config';
    
    /**
    *   _eventDispatcher
    *
    *   @var EventDispatcher
    */
    _eventDispatcher;

    /**
    *   _storage
    *
    *   @var localStorage
    */
    _storage;
    
    /**
    *   constructor
    *
    */
    constructor(eventDispatcher) {
        this._eventDispatcher = eventDispatcher;
        this._storage = window.localStorage;
        this._removeExpirationData();
        
    }
    
    /**
    *   _dispatchStorageEvent
    *
    */
    _dispatchStorageEvent(event) {
        this._eventDispatcher.dispatchEvent(
            'MarcheRepository_update_storage',
            event
        );
    }
    
    /**
    *   generateId
    *
    *   @return string
    */
    generateId() {
        return (new Date()).getTime();
    }
    
    /**
    *   dataCollection
    *
    *   @return MarcheDataCollection
    */
    dataCollection() {
        const item = this._storage.getItem(this._DATA_NAMESPACE);
        const data_collection = item? JSON.parse(item):{};
        const storage_data = data_collection[this._STORAGE_DATA] || {};
        return new MarcheDataCollection(storage_data);
    }
    
    /**
    *   setJobItem
    *
    *   @param string id
    *   @param object job_data
    *   @return this
    */
    setJobItem(id, job_data) {
        const event = {target:this, id:id, job_data:job_data};
        
        this._eventDispatcher.dispatchEvent(
            'MarcheRepository_setJobItem_before',
            event
        );
        
        const dataCollection = this.dataCollection();
        
        dataCollection.set(id, job_data);
            
        this._storage.setItem(
            this._DATA_NAMESPACE,
            JSON.stringify(dataCollection)
        );
        
        this._eventDispatcher.dispatchEvent(
            'MarcheRepository_setJobItem_after',
            event
        );
        
        this._dispatchStorageEvent(event);
        
        return this;
    }
    
    /**
    *   removeJobItem
    *
    *   @param string id
    *   @return this
    */
    removeJobItem(id) {
        const event = {target:this, id:id};
        
        this._eventDispatcher.dispatchEvent(
            'MarcheRepository_removeJobItem_before',
            event
        );
        
        const dataCollection = this.dataCollection();
        
        dataCollection.remove(id);
            
        this._storage.setItem(
            this._DATA_NAMESPACE,
            JSON.stringify(dataCollection)
        );
        
        this._eventDispatcher.dispatchEvent(
            'MarcheRepository_removeJobItem_after',
            event
        );
        
        this._dispatchStorageEvent(event);
        
        return this;
    }
    
    /**
    *   autoJob
    *
    *   @param ?string|int id
    *   @return this
    */
    autoJob(id) {
        id = id || UnixDate.now();
        const now = parseInt(id) 
        const _this = this;
        
        const auto_dates = this.getConfigs().autoDates();
        
        Object.keys(auto_dates).sort()
            .map((key) => {return auto_dates[key]})
            .forEach((obj) => {
        
            const today_date_start = UnixDate.setTimeString(
                UnixDate.today(),
                obj.auto_date_start
            );
            
            const data_collection = this.dataCollection();
            let latest_unixtime = data_collection.lastId();
        
            if (today_date_start < now
                && today_date_start > latest_unixtime
                && !data_collection.has(today_date_start)
            ) {
                _this.setJobItem(
                    today_date_start,
                    obj.auto_date_job
                );
                latest_unixtime = data_collection.lastId();
            }
            
            if (latest_unixtime != null
                && obj.auto_date_end != ''
                && UnixDate.isToday(latest_unixtime)
            ) {
                const today_date_end = UnixDate.setTimeString(
                    UnixDate.today(),
                    obj.auto_date_end
                );
                
                if (today_date_end < now
                    && today_date_start > latest_unixtime
                    && !data_collection.has(today_date_end)
                ) {
                    _this.setJobItem(
                        today_date_end,
                        data_collection.get(latest_unixtime)
                    );
                }
            }
        });
        return this;
    }
    
    /**
    *   _removeExpirationData
    *
    *   @return this
    */
    _removeExpirationData() {
        const expiration = this.getExpiration() || 0;
        
        if (expiration <= 0 || expiration >= 1000) {
            return this;
        }
        
        const today_unixtime = UnixDate.today();
        
        const expiaration_unixtime =
            today_unixtime - expiration * 60 * 60 * 24 * 1000;
        
        const dataCollection = this.dataCollection();
        
        Object.keys(dataCollection.all()).forEach((id) => {
            if (parseInt(id) < expiaration_unixtime) {
                this.removeJobItem(id);
            }
        });
    }
    
    /**
    *   import
    *
    *   @param object object
    *   @return this
    */
    import(object) {
        const event = {target:this, data:object};
        
        this._eventDispatcher.dispatchEvent(
            'MarcheRepository_importJson_before',
            event
        );
        
        let data = {};
        data[this._STORAGE_DATA] = object;
        
        this._storage.setItem(
            this._DATA_NAMESPACE,
            JSON.stringify(data)
        );
        
        this._eventDispatcher.dispatchEvent(
            'MarcheRepository_importJson_after',
            event
        );
        
        this._dispatchStorageEvent(event);
        
        return this;
    }
    
    ////////////////////////
    
    /**
    *   getConfigs
    *
    *   @return MarcheConfig
    */
    getConfigs() {
        const item = this._storage.getItem(this._CONFIG_NAMESPACE);
        const data_collection = item? JSON.parse(item):{};
        const storage_data = data_collection[this._STORAGE_DATA] || {};
        return new MarcheConfig(storage_data);
    }
    
    /**
    *   setExpiration
    *
    *   @param ?int day
    *   @return this
    */
    setExpiration(day = 60) {
        const event = {target:this, day:day};
        
        this._eventDispatcher.dispatchEvent(
            'MarcheRepository_setExpiration_before',
            event
        );
        
        const config = this.getConfigs();
        
        config.set('expiration', day);
            
        this._storage.setItem(
            this._CONFIG_NAMESPACE,
            JSON.stringify(config)
        );
        
        this._eventDispatcher.dispatchEvent(
            'MarcheRepository_setExpiration_after',
            event
        );
        
        this._dispatchStorageEvent(event);
        
        return this;
    }
    
    /**
    *   getExpiration
    *
    *   @return int
    */
    getExpiration() {
        const config = this.getConfigs();
        return config.get('expiration') || 0;
    }
    
    /**
    *   setAutoDate
    *
    *   @param string jobname
    *   @param string start_time_string
    *   @param ?string end_time_string
    *   @return this
    */
    setAutoDate(jobname, start_time_string, end_time_string = '') {
        const event = {
            target:this,
            jobname:jobname,
            start_time_string:start_time_string,
            end_time_string:end_time_string     
        };
            
        this._eventDispatcher.dispatchEvent(
            'MarcheRepository_setAutoDate_before',
            event
        );
        
        const auto_date = {};
        
        const id = start_time_string;
        auto_date.id = id;
        auto_date.auto_date_job = jobname;
        auto_date.auto_date_start = start_time_string;
        auto_date.auto_date_end = end_time_string;
        
        const config = this.getConfigs();
        const auto_dates = config.get('auto_date') || {};
        auto_dates[id] = auto_date;
        
        config.set('auto_date', auto_dates);
            
        this._storage.setItem(
            this._CONFIG_NAMESPACE,
            JSON.stringify(config)
        );
        
        this._eventDispatcher.dispatchEvent(
            'MarcheRepository_setAutoDate_after',
            event
        );
        
        this._dispatchStorageEvent(event);
        
        return this;
    }
    
    /**
    *   removeAutoDate
    *
    *   @param string id
    *   @return this
    */
    removeAutoDate(id) {
        const event = {target:this, id:id};
        
        this._eventDispatcher.dispatchEvent(
            'MarcheRepository_removeAutoDate_before',
            event
        );
        
        const auto_date = {};
        
        const config = this.getConfigs();
        const auto_dates = config.get('auto_date') || {};
        delete auto_dates[id];
        
        config.set('auto_date', auto_dates);
            
        this._storage.setItem(
            this._CONFIG_NAMESPACE,
            JSON.stringify(config)
        );
        
        this._eventDispatcher.dispatchEvent(
            'MarcheRepository_removeAutoDate_after',
            event
        );
        
        this._dispatchStorageEvent(event);
        
        return this;
    }
}
    
//////////////////////////////////////////

/**
*   JobInputView
*
*/
class JobInputView
{
    /**
    *   _eventDispatcher
    *
    *   @var EventDispatcher
    */
    _eventDispatcher;

    /**
    *   _repository
    *
    *   @var MarcheRepository
    */
    _repository;
    
    /**
    *   constructor
    *
    *   @param EventDispatcher eventDispatcher
    *   @param MarcheRepository repository
    */
    constructor(eventDispatcher, repository) {
        this._eventDispatcher = eventDispatcher;
        this._repository = repository;
        this._initEvent();
    }
    
    /**
    *   イベント初期化
    *
    */
    _initEvent() {
        this._eventDispatcher.addEventListener(
            'MarcheRepository_update_storage',
            () => this.render()
        );
        
        //登録ボタン
        document.querySelector('#job_input_view button[name="job_name_button"]')
            .addEventListener('click', (event) =>{
                event.preventDefault();
                
                this._eventDispatcher.dispatchEvent(
                    'JobInputView_inputJob_before',
                    {target:this, event:event}
                );
                
                const elem = document.querySelector(
                    '#job_input_view input[name="job_name"]'
                );
                
                const job_name = {};
                job_name.jobname = elem.value;
                
                if (! job_name.jobname) {
                    return;
                }
                
                job_name.id = this._repository.generateId();
                
                this._repository.autoJob(job_name.id);
                this._repository.setJobItem(job_name.id, job_name.jobname);
                
                elem.value = '';
                
                window.location.hash = '#timecard_view';
                
                this._eventDispatcher.dispatchEvent(
                    'JobInputView_inputJob_after',
                    {
                        target:this,
                        event:event,
                        job_name:job_name,
                    }
                );
            });
        
        
        //ダブルクリックで記録
        document.querySelector('#job_input_view tbody')
            .addEventListener('dblclick', (event) =>{
                event.preventDefault();
                
                this._eventDispatcher.dispatchEvent(
                    'JobInputView_addJob_before',
                    {target:this, event:event}
                );
                
                const job_input_table = {};
                job_input_table.id = this._repository.generateId();
                job_input_table.name = event.target.textContent;
                
                this._repository.autoJob(job_input_table.id);
                this._repository.setJobItem(
                    job_input_table.id,
                    event.target.textContent
                );
                
                window.location.hash = '#timecard_view';
                
                this._eventDispatcher.dispatchEvent(
                    'JobInputView_addJob_after',
                    {
                        target:this,
                        event:event,
                        job_input_table:job_input_table,
                    }
                );
            });
    }
    
    /**
    *   JOB入力 描画
    *
    */
    render() {
        const html = this._repository.dataCollection()
            .groupByJobNameOrderDesc()
            .map((jobname) => {
            
                return [
                    '<tr>',
                    `<td>${jobname}</td>`,
                    '</tr>'
                ].join('');
            });
        
        const elem = document.querySelector('#job_input_view table tbody');
        elem.textContent = null;
        elem.insertAdjacentHTML('beforeend', html.join(''));
    }
}

/**
*   TimeCardView
*
*/
class TimeCardView
{
    /**
    *   _eventDispatcher
    *
    *   @var EventDispatcher
    */
    _eventDispatcher;

    /**
    *   _repository
    *
    *   @var MarcheRepository
    */
    _repository;
    
    /**
    *   constructor
    *
    *   @param EventDispatcher eventDispatcher
    *   @param MarcheRepository repository
    */
    constructor(eventDispatcher, repository) {
        this._eventDispatcher = eventDispatcher;
        this._repository = repository;
        this._initView();
        this._initEvent();
    }
    
    /**
    *   画面初期化
    *
    */
    _initView() {
        document.querySelector('#timecard_view input[name="job_date"]')
            .value = DateFormatter.toDate(UnixDate.today());
    }
    
    /**
    *   イベント初期化
    *
    */
    _initEvent() {
        this._eventDispatcher.addEventListener(
            'MarcheRepository_update_storage',
            () => this.render()
        );
        
        this._eventDispatcher.addEventListener(
            'TotalDataView_changeDate_after',
            () => this.render()
        );
        
        //日付変更
        document.querySelector('#timecard_view input[name="job_date"]')
            .addEventListener('change', (event) =>{
                event.preventDefault();
                
                this._eventDispatcher.dispatchEvent(
                    'TimeCardView_changeDate_before',
                    {target:this, event:event}
                );
                
                const job_date = {};
                job_date.job_date = event.target.value;
                
                const elem = document.querySelector(
                    '#total_data_view input[name="job_date"]'
                ).value = event.target.value;
                
                this.render();
                
                this._eventDispatcher.dispatchEvent(
                    'TimeCardView_changeDate_after',
                    {
                        target:this,
                        event:event,
                        job_date:job_date,
                    }
                );
            });
            
        //タイムカード削除
        document.querySelector('#timecard_view table tbody')
            .addEventListener('dblclick', (event) =>{
                event.preventDefault();
                
                this._eventDispatcher.dispatchEvent(
                    'TimeCardView_removeData_before',
                    {target:this, event:event}
                );
                
                const timecard_table = {};
                timecard_table.name = event.target.parentNode
                    .children[1].textContent;
                timecard_table.start_time = event.target.parentNode
                    .children[2].textContent;
                
                if (!confirm(timecard_table.name
                    + ' ' 
                    + timecard_table.start_time + 'を削除しますか')
                ) {
                    return;
                }
                
                timecard_table.id = event.target.parentNode
                    .firstChild.textContent;
                
                this._repository.removeJobItem(timecard_table.id);
                
                this._eventDispatcher.dispatchEvent(
                    'TimeCardView_removeData_after',
                    {
                        target:this,
                        event:event,
                        timecard_table:timecard_table,
                    }
                );
            });
    }
    
    /**
    *   タイムカード 描画
    *
    */
    render() {
        const target_str_date =
            document.querySelector('#timecard_view input[name="job_date"]')
            .value;
        
        const html = this._repository.dataCollection()
            .findByDateString(target_str_date)
            .map((job_data) => {
                return [
                '<tr>',
                `<td class="display-none">${job_data.id}</td>`,
                `<td>${job_data.name}</td>`,
                `<td>${job_data.start_time}</td>`,
                `<td>${job_data.diff_time || ''}</td>`,
                '</tr>',
                ].join('');
            });
        
        const elem = document.querySelector('#timecard_view table tbody');
        elem.textContent = null;
        elem.insertAdjacentHTML('beforeend', html.join(''));
    }
}

/**
*   TotalDataView
*
*/
class TotalDataView
{
    /**
    *   _eventDispatcher
    *
    *   @var EventDispatcher
    */
    _eventDispatcher;

    /**
    *   _repository
    *
    *   @var MarcheRepository
    */
    _repository;
    
    /**
    *   constructor
    *
    *   @param EventDispatcher eventDispatcher
    *   @param MarcheRepository repository
    */
    constructor(eventDispatcher, repository) {
        this._eventDispatcher = eventDispatcher;
        this._repository = repository;
        this._initView();
        this._initEvent();
    }
    
    /**
    *   画面初期化
    *
    */
    _initView() {
        document.querySelector('#total_data_view input[name="job_date"]')
            .value = DateFormatter.toDate(UnixDate.today());
    }
    
    /**
    *   イベント初期化
    *
    */
    _initEvent() {
        this._eventDispatcher.addEventListener(
            'MarcheRepository_update_storage',
            () => this.render()
        );
        
        this._eventDispatcher.addEventListener(
            'TimeCardView_changeDate_after',
            () => this.render()
        );
        
        //日付変更
        document.querySelector('#total_data_view input[name="job_date"]')
            .addEventListener('change', (event) =>{
                event.preventDefault();
                
                this._eventDispatcher.dispatchEvent(
                    'TotalDataView_changeDate_before',
                    {target:this, event:event}
                );
                
                const job_date = {};
                job_date.job_date = event.value;
                
                document.querySelector(
                    '#timecard_view input[name="job_date"]'
                ).value = event.target.value;
                
                this.render();
                
                this._eventDispatcher.dispatchEvent(
                    'TotalDataView_changeDate_after',
                    {
                        target:this,
                        event:event,
                        job_date:job_date
                    }
                );
            });
    }
    
    /**
    *   集計 描画
    *
    */
    render() {
        const target_str_date =
            document.querySelector(
                '#total_data_view input[name="job_date"]'
            ).value;
        
        let today_total = 0;
        
        let html = this._repository.dataCollection()
            .groupByDateString(target_str_date)
            .map((job_data) => {
            
            today_total += job_data.diff_time;
            
            return [
                '<tr>',
                `<td>${job_data.name}</td>`,
                `<td>${job_data.diff_time.toFixed(2)}</td>`,
                '</tr>',
            ].join('');
        });
        
        html = html.concat([
            '<tr>',
            '<td>合計</td>',
            `<td>${today_total.toFixed(2)}</td>`,
            '</tr>',
        ].join(''));
        
        const elem = document.querySelector('#total_data_view table tbody');
        elem.textContent = null;
        elem.insertAdjacentHTML('beforeend', html.join(''));
    }
}

/**
*   ConfigView
*
*/
class ConfigView
{
    /**
    *   _eventDispatcher
    *
    *   @var EventDispatcher
    */
    _eventDispatcher;

    /**
    *   _repository
    *
    *   @var MarcheRepository
    */
    _repository;
    
    /**
    *   constructor
    *
    *   @param EventDispatcher eventDispatcher
    *   @param MarcheRepository repository
    */
    constructor(eventDispatcher, repository) {
        this._eventDispatcher = eventDispatcher;
        this._repository = repository;
        this._repository.autoJob();
        this._initEvent();
    }
    
    /**
    *   イベント初期化
    *
    */
    _initEvent() {
        this._eventDispatcher.addEventListener(
            'MarcheRepository_update_storage',
            () => this.render()
        );
        
        document.querySelector(
            '#config_view button[name="config_expiration_button"]'
            ).addEventListener('click', (event) =>{
                event.preventDefault();
                
                this._eventDispatcher.dispatchEvent(
                    'ConfigView_setExpiration_before',
                    {target:this, event:event}
                );
                
                const expire_day = {};
                expire_day.expire_day = document.querySelector(
                    '#config_view input[name="config_expiration"]'
                ).value;
                
                this._repository.setExpiration(expire_day.expire_day);
                
                this._eventDispatcher.dispatchEvent(
                    'ConfigView_setExpiration_after',
                    {target:this, event:event, expire_day:expire_day}
                );
            });
        
        document.querySelector('#config_view button[name="auto_date_button"]')
            .addEventListener('click', (event) =>{
                event.preventDefault();
                
                this._eventDispatcher.dispatchEvent(
                    'ConfigView_addAutoDate_before',
                    {target:this, event:event}
                );
                
                const auto_date = {};
                
                let elem_job = document.querySelector(
                    '#config_view input[name="auto_date_job"]'
                );
                auto_date.auto_date_job = elem_job.value;
                
                let elem_start = document.querySelector(
                    '#config_view input[name="auto_date_start"]'
                );
                auto_date.auto_date_start = elem_start.value;
                
                if (auto_date.auto_date_job.trim() === ''
                    || auto_date.auto_date_start.trim() === ''
                ) {
                    this._eventDispatcher.dispatchEvent(
                        'ConfigView_addAutoDate_data_empty',
                        {
                            target:this,
                            event:event,
                            auto_date:auto_date,
                        }
                    );
                    return;
                }
                
                let elem_end = document.querySelector(
                    '#config_view input[name="auto_date_end"]'
                );
                auto_date.auto_date_end = elem_end.value;
                
                this._repository.setAutoDate(
                    auto_date.auto_date_job,
                    auto_date.auto_date_start,
                    auto_date.auto_date_end
                );
                
                this._repository.autoJob();
                
                elem_job.value = '';
                elem_start.value = '';
                elem_end.value = '';
                
                this._eventDispatcher.dispatchEvent(
                    'ConfigView_addAutoDate_after',
                    {
                        target:this,
                        event:event,
                        auto_date:auto_date,
                    }
                );
            });
        
        document.querySelector('#auto_date_table tbody')
            .addEventListener('dblclick', (event) =>{
                event.preventDefault();
                
                this._eventDispatcher.dispatchEvent(
                    'ConfigView_removeAutoDate_before',
                    {target:this, event:event}
                );
                
                const auto_date = {};
                auto_date.auto_date_job = event.target.parentNode
                    .children[1].textContent;
                auto_date.auto_date_start = event.target.parentNode
                    .children[2].textContent;
                auto_date.auto_date_end = event.target.parentNode
                    .children[3].textContent;
                
                
                if (!confirm(auto_date.auto_date_job
                    + ' '
                    + auto_date.auto_date_start + 'を削除しますか')
                ) {
                    return;
                }
                
                auto_date.id = event.target.parentNode
                    .firstChild.textContent;
                
                this._repository.removeAutoDate(auto_date.id);
                this._repository.autoJob();
                
                this._eventDispatcher.dispatchEvent(
                    'ConfigView_removeAutoDate_after',
                    {
                        target:this,
                        event:event,
                        auto_date:auto_date,
                    }
                );
            });
    }
    
    /**
    *   設定 描画
    *
    */
    render() {
        document.querySelector('#config_view input[name="config_expiration"]')
            .value = this._repository.getExpiration();
        
        const html = Object.values(this._repository.getConfigs().autoDates())
            .sort()
            .map((obj) => {
                return [
                    '<tr>',
                    `<td class="display-none">${obj.id}</td>`,
                    `<td>${obj.auto_date_job}</td>`,
                    `<td>${obj.auto_date_start}</td>`,
                    `<td>${obj.auto_date_end || ''}</td>`,
                    '</tr>'
                ].join('')
        });
        
        const elem = document.querySelector('#auto_date_table tbody');
        elem.textContent = null;
        elem.insertAdjacentHTML('beforeend', html.join(''));
    }
}

/**
*   MessageView
*
*/
class MessageView
{
    /**
    *   _eventDispatcher
    *
    *   @var EventDispatcher
    */
    _eventDispatcher;

    /**
    *   constructor
    *
    *   @param EventDispatcher eventDispatcher
    */
    constructor(eventDispatcher) {
        this._eventDispatcher = eventDispatcher;
        this._initEvent();
    }
    
    /**
    *   イベント初期化
    *
    */
    _initEvent() {
        this._eventDispatcher.addEventListener(
            'JobInputView_inputJob_after',
            (event) => {
                this.info(
                    `${event.job_name.jobname} 登録しました`,
                    _MESSGAGE_DELAY_INFO
                );
            }
        );
        
        this._eventDispatcher.addEventListener(
            'JobInputView_addJob_after',
            (event) => {
                this.info(
                    `${event.job_input_table.name} 登録しました`,
                    _MESSGAGE_DELAY_INFO
                );
            }
        );
        
        this._eventDispatcher.addEventListener(
            'TimeCardView_removeData_after',
            (event) => {
                this.info(
                    `${event.timecard_table.start_time} ${event.timecard_table.name} 削除しました`,
                    _MESSGAGE_DELAY_INFO
                );
            }
        );
        
        this._eventDispatcher.addEventListener(
            'ConfigView_setExpiration_after',
            (event) => {
                this.info(
                    `データ保持日数 ${event.expire_day.expire_day} 設定しました`,
                    _MESSGAGE_DELAY_INFO
                );
            }
        );
        
        this._eventDispatcher.addEventListener(
            'ConfigView_addAutoDate_after',
            (event) => {
                this.info(
                    `自動JOB ${event.auto_date.auto_date_job} 設定しました`,
                    _MESSGAGE_DELAY_INFO
                );
            }
        );
        
        this._eventDispatcher.addEventListener(
            'ConfigView_addAutoDate_data_empty',
            (event) => {
                this.error(
                    `自動JOB 入力が正しくありません`,
                    _MESSGAGE_DELAY_ERROR
                );
            }
        );
        
        this._eventDispatcher.addEventListener(
            'ConfigView_removeAutoDate_after',
            (event) => {
                this.info(
                    `自動JOB ${event.auto_date.auto_date_job} 削除しました`,
                    _MESSGAGE_DELAY_INFO
                );
            }
        );
         
        this._eventDispatcher.addEventListener(
            'CsvView_drop_error',
            (event) => {
                this.error(
                    `インポート失敗しました`,
                    _MESSGAGE_DELAY_ERROR
                );
            }
        );
         
        this._eventDispatcher.addEventListener(
            'CsvView_drop_onload',
            (event) => {
                this.info(
                    `インポート完了しました`,
                    _MESSGAGE_DELAY_INFO
                );
            }
        );
    }
    
    /**
    *   メッセージウィンドウ非表示
    *
    *
    */
    close() {
        const message_body = document.querySelector(
            '#message_view div:first-child'
        );
        
        message_body.textContent = "";
        
        message_body.classList.remove('background-color-info');
        message_body.classList.remove('u-background-color-warning');
        message_body.classList.remove('background-color-error');
        
        document.querySelector('#message_view')
            .classList.add('display-none');
            
        document.body.classList.remove('position-fixed');
    }

    /**
    *   描画
    *
    *   @param string class_name
    *   @param string message
    *   @param int delay_time
    *
    */
    render(class_name, message, delay_time) {
        const message_body = document.querySelector(
            '#message_view div:first-child'
        );
        
        message_body.textContent = message.replace("\n", '<br>');
        message_body.classList.add(class_name);
        
        delay_time = delay_time * 1000 || 1000;
        setTimeout(this.close, delay_time);
        
        document.querySelector('#message_view')
            .classList.remove('display-none');
        
        document.body.classList.add('position-fixed');
    }

    /**
    *   メッセージウィンドウ 通知描画
    *
    *   @param string message
    *   @param int delay_time
    *
    */
    info(message, delay_time = 1) {
        this.render('background-color-info', message, delay_time);
    };

    /**
    *   メッセージウィンドウ エラー描画
    *
    *   @param string message
    *   @param int delay_time
    *
    */
    error(message, delay_time = 1) {
        this.render('background-color-error', message, delay_time);
    };
}

/**
*   TitleHeaderView
*
*/
class TitleHeaderView
{
    /**
    *   _eventDispatcher
    *
    *   @var EventDispatcher
    */
    _eventDispatcher;

    /**
    *   _repository
    *
    *   @var MarcheRepository
    */
    _repository;
    
    /**
    *   constructor
    *
    *   @param EventDispatcher eventDispatcher
    *   @param MarcheRepository repository
    */
    constructor(eventDispatcher, repository) {
        this._eventDispatcher = eventDispatcher;
        this._repository = repository;
        this._initEvent();
    }
    
    /**
    *   イベント初期化
    *
    */
    _initEvent() {
        document.querySelector('header button[name="csv_button"]')
            .addEventListener('click', (event) =>{
                event.preventDefault();
                
                const storage_data = this._repository.dataCollection()
                    .all();
                    
                const html = Object.keys(storage_data)
                    .sort()
                    .map((jobtime) => {
                        return [
                            `${DateFormatter.toDate(jobtime)},`,
                            `${DateFormatter.toTime(jobtime)},`,
                            `${storage_data[jobtime]}`,
                    ].join('');
                });
                
                document.querySelector('textarea[name="csv_data"]')
                    .value = html.join("\n");
                
                document.querySelector('#csv_view')
                    .classList.remove('display-none');
                
                document.body.classList.add('position-fixed');
            });
    }
}

/**
*   CsvView
*
*/
class CsvView
{
    /**
    *   _eventDispatcher
    *
    *   @var EventDispatcher
    */
    _eventDispatcher;


    /**
    *   _repository
    *
    *   @var MarcheRepository
    */
    _repository;
    
    /**
    *   constructor
    *
    *   @param EventDispatcher eventDispatcher
    *   @param MarcheRepository repository
    */
    constructor(eventDispatcher, repository) {
        this._eventDispatcher = eventDispatcher;
        this._repository = repository;
        this._initEvent();
    }
    
    /**
    *   イベント初期化
    *
    */
    _initEvent() {
        document.querySelector('#csv_view button[name="csv_close_button"]')
            .addEventListener('click', (event) =>{
                event.preventDefault();
                
                document.querySelector('#csv_view')
                    .classList.add('display-none');
                
                document.body.classList.remove('position-fixed');
            });
        
        document.querySelector('#csv_view button[name="export_button"]')
            .addEventListener('click', (event) =>{
                event.preventDefault();
                
                const blob = new Blob(
                    [JSON.stringify(this._repository.dataCollection().all())], 
                    {type: 'text/plain'}
                );
                
                const link = document.createElement('a');
                link.download = 'data.json';
                link.href = URL.createObjectURL(blob);
                link.click();
                URL.revokeObjectURL(link.href);
            });
        
        let dropbox = document.getElementById("csv_view");
    
        document.querySelector('#csv_view')
            .addEventListener('dragenter', (event) =>{
                event.stopPropagation();
                event.preventDefault();
            });
        
        document.querySelector('#csv_view')
            .addEventListener('dragover', (event) =>{
                event.stopPropagation();
                event.preventDefault();
            });
        
        document.querySelector('#csv_view')
            .addEventListener('drop', (event) =>{
                event.stopPropagation();
                event.preventDefault();
                
                const dataTransfer = event.dataTransfer;
                const fileList = dataTransfer === null?
                    []:dataTransfer.files;
                
                if (fileList.length != 1) {
                    this._eventDispatcher.dispatchEvent(
                        'CsvView_drop_error',
                        {
                            target:this,
                            event:event,
                        }
                    );
                    return;
                }
                
                const fileReader = new FileReader();
                
                fileReader.onerror = (event) =>{
                    fileReader.abort();
                    this._eventDispatcher.dispatchEvent(
                        'CsvView_drop_error',
                        {
                            target:this,
                            event:event,
                        }
                    );
                };
                
                 fileReader.onload = (event) =>{
                    this._repository.import(
                        JSON.parse(event.target.result)
                    );
                    
                    this._eventDispatcher.dispatchEvent(
                        'CsvView_drop_onload',
                        {
                            target:this,
                            event:event,
                        }
                    );
                };
                
                fileReader.readAsText(fileList[0]);
            });
    }
}

///////////////////

try {
    var eventDispatcher = new EventDispatcher();
    
    const repository = new MarcheRepository(eventDispatcher);
    
    const messageView = new MessageView(eventDispatcher);
    
    const jobInputView = new JobInputView(eventDispatcher, repository);
    
    const timeCardView = new TimeCardView(eventDispatcher, repository);
    
    const totalDataView = new TotalDataView(eventDispatcher, repository);
    
    const configView = new ConfigView(eventDispatcher, repository);
    
    const titleHeaderView = new TitleHeaderView(eventDispatcher, repository);
    
    const csvView = new CsvView(eventDispatcher, repository);
    
    configView.render();
    jobInputView.render();
    timeCardView.render();
    totalDataView.render();
    
} catch (e) {
    console.error(e);
    MessageView.error(e);
} 

</script>

</body>
</html>
